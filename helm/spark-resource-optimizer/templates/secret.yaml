apiVersion: v1
kind: Secret
metadata:
  name: {{ include "spark-resource-optimizer.databaseSecretName" . }}
  labels:
    {{- include "spark-resource-optimizer.labels" . | nindent 4 }}
type: Opaque
stringData:
  {{- if .Values.database.external }}
  SPARK_OPTIMIZER_DB_URL: {{ printf "postgresql://%s:%s@%s:%d/%s?sslmode=%s" .Values.database.username .Values.database.password .Values.database.host (int .Values.database.port) .Values.database.name .Values.database.sslMode | quote }}
  {{- else if .Values.postgresql.enabled }}
  SPARK_OPTIMIZER_DB_URL: {{ printf "postgresql://%s:%s@%s-postgresql:5432/%s" .Values.postgresql.auth.username .Values.postgresql.auth.password .Release.Name .Values.postgresql.auth.database | quote }}
  {{- else }}
  SPARK_OPTIMIZER_DB_URL: "sqlite:///spark_optimizer.db"
  {{- end }}
---
{{- if .Values.config.features.auth }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "spark-resource-optimizer.jwtSecretName" . }}
  labels:
    {{- include "spark-resource-optimizer.labels" . | nindent 4 }}
type: Opaque
stringData:
  {{- if .Values.auth.jwt.secretKey }}
  JWT_SECRET_KEY: {{ .Values.auth.jwt.secretKey | quote }}
  {{- else }}
  JWT_SECRET_KEY: {{ randAlphaNum 64 | quote }}
  {{- end }}
  {{- if .Values.auth.initialAdmin.enabled }}
  INITIAL_ADMIN_USERNAME: {{ .Values.auth.initialAdmin.username | quote }}
  INITIAL_ADMIN_EMAIL: {{ .Values.auth.initialAdmin.email | quote }}
  {{- if .Values.auth.initialAdmin.password }}
  INITIAL_ADMIN_PASSWORD: {{ .Values.auth.initialAdmin.password | quote }}
  {{- else }}
  INITIAL_ADMIN_PASSWORD: {{ randAlphaNum 16 | quote }}
  {{- end }}
  {{- end }}
{{- end }}
