name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  pr-title-check:
    name: Check PR Title
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
    - name: Check PR title format
      uses: amannn/action-semantic-pull-request@v5
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        types: |
          feat
          fix
          docs
          style
          refactor
          perf
          test
          build
          ci
          chore
          revert
        requireScope: false
        subjectPattern: ^(?![A-Z]).+$
        subjectPatternError: |
          The subject "{subject}" found in the pull request title "{title}"
          didn't match the configured pattern. Please ensure that the subject
          doesn't start with an uppercase character.

  pr-size-check:
    name: Check PR Size
    runs-on: ubuntu-latest

    steps:
    - name: Check PR size
      uses: actions/github-script@v7
      with:
        script: |
          const pr = context.payload.pull_request;
          const additions = pr.additions;
          const deletions = pr.deletions;
          const total = additions + deletions;

          let label = '';
          if (total < 100) {
            label = 'size/XS';
          } else if (total < 300) {
            label = 'size/S';
          } else if (total < 600) {
            label = 'size/M';
          } else if (total < 1000) {
            label = 'size/L';
          } else {
            label = 'size/XL';
          }

          // Add size label
          await github.rest.issues.addLabels({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: pr.number,
            labels: [label]
          });

          // Warn if PR is too large
          if (total > 1000) {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: '⚠️ This PR is quite large (>1000 lines changed). Consider breaking it into smaller PRs for easier review.'
            });
          }

  label-check:
    name: Check PR Labels
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
    - name: Check for labels
      uses: actions/github-script@v7
      with:
        script: |
          const pr = context.payload.pull_request;
          const labels = pr.labels.map(l => l.name);

          const requiredLabelGroups = [
            ['bug', 'enhancement', 'documentation', 'dependencies', 'refactor']
          ];

          for (const group of requiredLabelGroups) {
            const hasLabel = labels.some(label => group.includes(label));
            if (!hasLabel) {
              core.setFailed(`PR must have at least one label from: ${group.join(', ')}`);
            }
          }

  conflict-check:
    name: Check for Merge Conflicts
    runs-on: ubuntu-latest

    steps:
    - name: Check for conflicts
      uses: actions/github-script@v7
      with:
        script: |
          const pr = context.payload.pull_request;
          if (pr.mergeable === false) {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: '⚠️ This PR has merge conflicts. Please resolve them before proceeding.'
            });
            core.setFailed('PR has merge conflicts');
          }

  branch-check:
    name: Check Branch Name
    runs-on: ubuntu-latest

    steps:
    - name: Check branch name
      uses: actions/github-script@v7
      with:
        script: |
          const branch = context.payload.pull_request.head.ref;
          const validPrefixes = ['feature/', 'fix/', 'docs/', 'refactor/', 'test/', 'chore/'];

          if (!validPrefixes.some(prefix => branch.startsWith(prefix))) {
            core.warning(`Branch name "${branch}" doesn't follow naming convention: ${validPrefixes.join(', ')}`);
          }
